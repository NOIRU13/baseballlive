/**
 * é‡çƒã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ - ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * OBS Studio ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ç”¨
 */

// ==================== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ====================
const DEFAULT_STATE = {
    teams: {
        home: 'ãƒ›ãƒ¼ãƒ ',
        away: 'ã‚¢ã‚¦ã‚§ã‚¤'
    },
    inning: {
        number: 1,
        half: 'top' // 'top' = è¡¨, 'bottom' = è£
    },
    // å„ã‚¤ãƒ‹ãƒ³ã‚°ã®å¾—ç‚¹ï¼ˆæœ€å¤§12ã‚¤ãƒ‹ãƒ³ã‚°åˆ†ï¼‰
    scores: {
        home: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        away: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    },
    count: {
        ball: 0,
        strike: 0,
        out: 0
    },
    runners: {
        first: false,
        second: false,
        third: false
    },
    // R(å¾—ç‚¹åˆè¨ˆ), H(ãƒ’ãƒƒãƒˆ), E(ã‚¨ãƒ©ãƒ¼)
    stats: {
        home: { r: 0, h: 0, e: 0 },
        away: { r: 0, h: 0, e: 0 }
    },
    // æ‰“é †ãƒ‡ãƒ¼ã‚¿ï¼ˆ9äººåˆ†ã®é¸æ‰‹åï¼‰
    lineup: {
        home: ['', '', '', '', '', '', '', '', ''],
        away: ['', '', '', '', '', '', '', '', '']
    },
    // ç¾åœ¨ã®æ‰“é †ä½ç½®ï¼ˆ0-8ï¼‰
    currentBatter: {
        home: 0,
        away: 0
    },
    // å„é¸æ‰‹ã®æ‰“å¸­çµæœå±¥æ­´
    // ä¾‹: { home: [['single', 'groundout'], [], ...], away: [...] }
    atBatResults: {
        home: [[], [], [], [], [], [], [], [], []],
        away: [[], [], [], [], [], [], [], [], []]
    },
    // çµæœå–ã‚Šæ¶ˆã—ç”¨ã®å±¥æ­´
    resultHistory: []
};

// æ‰“å¸­çµæœã®ãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°
const RESULT_LABELS = {
    'single': 'å˜',
    'double': '2',
    'triple': '3',
    'homerun': 'HR',
    'walk': 'å››',
    'hbp': 'æ­»',
    'error': 'E',
    'strikeout': 'K',
    'groundout': 'ã‚´',
    'flyout': 'ãƒ•',
    'lineout': 'ãƒ©',
    'sacrifice': 'çŠ ',
    'fc': 'FC',
    'dp': 'ä½µ'
};

// ç¾åœ¨ã®çŠ¶æ…‹
let state = {};

// LocalStorageã‚­ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
const STORAGE_KEY = 'baseballScoreboard';

// APIè¨­å®š
const API_BASE_URL = 'http://localhost:3000/api';
let useAPI = true; // APIãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹

// BroadcastChannelï¼ˆã‚¿ãƒ–é–“ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸç”¨ï¼‰
const CHANNEL_NAME = 'baseballScoreboard';
let broadcastChannel = null;

// ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
let isAdminMode = false;
let isDisplayMode = false;

// ==================== åˆæœŸåŒ– ====================
document.addEventListener('DOMContentLoaded', async () => {
    // ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
    checkPageMode();
    
    // APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    await checkAPIHealth();
    
    // çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿
    await loadState();
    
    // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿æ‰“é †å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆ
    if (isAdminMode) {
        generateLineupInputs();
    }
    
    // UIã®æ›´æ–°
    updateDisplay();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šï¼ˆç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
    if (isAdminMode) {
        setupEventListeners();
    }
    
    // BroadcastChannelã®è¨­å®šï¼ˆå…¨ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹åŒ–ï¼‰
    setupBroadcastChannel();
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€å®šæœŸçš„ã«åŒæœŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    if (isDisplayMode) {
        setupStorageSync();
    }
});

/**
 * ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®šï¼ˆç®¡ç†ç”»é¢ or è¡¨ç¤ºç”»é¢ï¼‰
 */
function checkPageMode() {
    // bodyã®ã‚¯ãƒ©ã‚¹ã§ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®š
    isAdminMode = document.body.classList.contains('admin-mode');
    isDisplayMode = document.body.classList.contains('display-mode');
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®š
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    
    if (mode === 'overlay') {
        document.body.classList.add('overlay-mode');
    }
}

/**
 * APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
 */
async function checkAPIHealth() {
    try {
        const response = await fetch(`${API_BASE_URL}/health`, { 
            method: 'GET',
            signal: AbortSignal.timeout(3000) // 3ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        });
        if (response.ok) {
            useAPI = true;
            console.log('âœ… APIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ');
        } else {
            throw new Error('API not available');
        }
    } catch (e) {
        useAPI = false;
        console.warn('âš ï¸ APIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚localStorageã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
    }
}

/**
 * BroadcastChannelã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¿ãƒ–é–“ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼‰
 */
function setupBroadcastChannel() {
    try {
        broadcastChannel = new BroadcastChannel(CHANNEL_NAME);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†
        broadcastChannel.onmessage = (event) => {
            if (event.data && event.data.type === 'STATE_UPDATE') {
                console.log('ğŸ“¡ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆå—ä¿¡: çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™');
                // å—ä¿¡ã—ãŸçŠ¶æ…‹ã‚’ãƒãƒ¼ã‚¸ã—ã¦æ›´æ–°
                state = deepMerge(JSON.parse(JSON.stringify(DEFAULT_STATE)), event.data.state);
                // localStorageã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                // UIã‚’å³åº§ã«æ›´æ–°
                updateDisplay();
            }
        };
        
        console.log('âœ… BroadcastChannel ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
    } catch (e) {
        console.warn('âš ï¸ BroadcastChannel ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“:', e);
    }
}

/**
 * çŠ¶æ…‹å¤‰æ›´ã‚’ä»–ã®ã‚¿ãƒ–ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
 */
function broadcastState() {
    if (broadcastChannel) {
        try {
            broadcastChannel.postMessage({
                type: 'STATE_UPDATE',
                state: state,
                timestamp: Date.now()
            });
            console.log('ğŸ“¤ çŠ¶æ…‹ã‚’ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã—ã¾ã—ãŸ');
        } catch (e) {
            console.warn('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆå¤±æ•—:', e);
        }
    }
}

/**
 * è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šå®šæœŸçš„ã«çŠ¶æ…‹ã‚’åŒæœŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
 */
function setupStorageSync() {
    // BroadcastChannelãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    // ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’é•·ã‚ã«è¨­å®šï¼ˆBroadcastChannelãŒãƒ¡ã‚¤ãƒ³ãªã®ã§ï¼‰
    setInterval(async () => {
        await loadState();
        updateDisplay();
    }, 2000); // 2ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
}

/**
 * çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚€ï¼ˆAPIå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§localStorageï¼‰
 */
async function loadState() {
    // APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
    if (useAPI) {
        try {
            const response = await fetch(`${API_BASE_URL}/state`);
            if (response.ok) {
                const data = await response.json();
                state = deepMerge(JSON.parse(JSON.stringify(DEFAULT_STATE)), data.state);
                // localStorageã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                return;
            }
        } catch (e) {
            console.warn('APIã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
        }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorage
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            state = deepMerge(JSON.parse(JSON.stringify(DEFAULT_STATE)), parsed);
        } else {
            state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        }
    } catch (e) {
        console.error('çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
        state = JSON.parse(JSON.stringify(DEFAULT_STATE));
    }
}

/**
 * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ·±ã„ãƒãƒ¼ã‚¸
 */
function deepMerge(target, source) {
    for (const key in source) {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            if (!target[key]) target[key] = {};
            deepMerge(target[key], source[key]);
        } else {
            target[key] = source[key];
        }
    }
    return target;
}

/**
 * çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ï¼ˆAPIå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§localStorageï¼‰
 */
async function saveState() {
    // å¸¸ã«localStorageã«ã‚‚ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
        console.error('localStorageã¸ã®ä¿å­˜ã«å¤±æ•—:', e);
    }
    
    // BroadcastChannelã§ä»–ã®ã‚¿ãƒ–ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
    broadcastState();
    
    // APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
    if (useAPI) {
        try {
            await fetch(`${API_BASE_URL}/state`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state })
            });
        } catch (e) {
            console.warn('APIã¸ã®ä¿å­˜ã«å¤±æ•—:', e);
        }
    }
}

// ==================== è¡¨ç¤ºæ›´æ–° ====================
/**
 * å…¨ã¦ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
 */
function updateDisplay() {
    updateTeamDisplay();
    updateInningDisplay();
    updateCountDisplay();
    updateRunnerDisplay();
    updateScoreDisplay();
    updateRHEDisplay();
    updateControlPanel();
    updateLineupDisplay();
    updateCurrentBatterDisplay();
}

/**
 * ãƒãƒ¼ãƒ åã®è¡¨ç¤ºã‚’æ›´æ–°
 */
function updateTeamDisplay() {
    // è¡¨ç¤ºç”»é¢ç”¨ã®ãƒãƒ¼ãƒ åè¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const awayDisplay = document.querySelector('#team-away-display .team-name');
    const homeDisplay = document.querySelector('#team-home-display .team-name');
    if (awayDisplay) awayDisplay.textContent = state.teams.away;
    if (homeDisplay) homeDisplay.textContent = state.teams.home;
}

/**
 * ã‚¤ãƒ‹ãƒ³ã‚°è¡¨ç¤ºã‚’æ›´æ–°
 */
function updateInningDisplay() {
    const halfSymbol = state.inning.half === 'top' ? 'â–²' : 'â–¼';
    const halfText = state.inning.half === 'top' ? 'è¡¨' : 'è£';
    
    // è¡¨ç¤ºç”»é¢ç”¨ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const inningHalf = document.getElementById('inning-half');
    const inningNumber = document.getElementById('inning-number');
    if (inningHalf) inningHalf.textContent = halfSymbol;
    if (inningNumber) inningNumber.textContent = state.inning.number;
    
    // ç®¡ç†ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const inningInfo = document.getElementById('inning-info');
    if (inningInfo) inningInfo.textContent = `${state.inning.number}å› ${halfText}`;
}

/**
 * ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
 */
function updateCountDisplay() {
    // ãƒœãƒ¼ãƒ«
    const ballDots = document.querySelectorAll('#ball-dots .dot');
    ballDots.forEach((dot, i) => {
        dot.classList.toggle('active', i < state.count.ball);
    });
    
    // ã‚¹ãƒˆãƒ©ã‚¤ã‚¯
    const strikeDots = document.querySelectorAll('#strike-dots .dot');
    strikeDots.forEach((dot, i) => {
        dot.classList.toggle('active', i < state.count.strike);
    });
    
    // ã‚¢ã‚¦ãƒˆ
    const outDots = document.querySelectorAll('#out-dots .dot');
    outDots.forEach((dot, i) => {
        dot.classList.toggle('active', i < state.count.out);
    });
}

/**
 * ãƒ©ãƒ³ãƒŠãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
 */
function updateRunnerDisplay() {
    // è¡¨ç¤ºç”»é¢ç”¨ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const runnerFirst = document.getElementById('runner-first');
    const runnerSecond = document.getElementById('runner-second');
    const runnerThird = document.getElementById('runner-third');
    if (runnerFirst) runnerFirst.classList.toggle('active', state.runners.first);
    if (runnerSecond) runnerSecond.classList.toggle('active', state.runners.second);
    if (runnerThird) runnerThird.classList.toggle('active', state.runners.third);
}

/**
 * å¾—ç‚¹è¡¨ç¤ºã‚’æ›´æ–°
 */
function updateScoreDisplay() {
    // åˆè¨ˆå¾—ç‚¹ã‚’è¨ˆç®—
    const awayTotal = state.scores.away.reduce((sum, score) => sum + score, 0);
    const homeTotal = state.scores.home.reduce((sum, score) => sum + score, 0);
    
    // è¡¨ç¤ºç”»é¢ç”¨ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const awayTotalEl = document.getElementById('away-total');
    const homeTotalEl = document.getElementById('home-total');
    if (awayTotalEl) awayTotalEl.textContent = awayTotal;
    if (homeTotalEl) homeTotalEl.textContent = homeTotal;
    
    // Rï¼ˆå¾—ç‚¹ï¼‰ã®æ›´æ–°
    state.stats.away.r = awayTotal;
    state.stats.home.r = homeTotal;
}

/**
 * R/H/Eè¡¨ç¤ºã‚’æ›´æ–°
 */
function updateRHEDisplay() {
    // è¡¨ç¤ºç”»é¢ç”¨ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const awayR = document.getElementById('away-r');
    const awayH = document.getElementById('away-h');
    const awayE = document.getElementById('away-e');
    const homeR = document.getElementById('home-r');
    const homeH = document.getElementById('home-h');
    const homeE = document.getElementById('home-e');
    
    if (awayR) awayR.textContent = state.stats.away.r;
    if (awayH) awayH.textContent = state.stats.away.h;
    if (awayE) awayE.textContent = state.stats.away.e;
    if (homeR) homeR.textContent = state.stats.home.r;
    if (homeH) homeH.textContent = state.stats.home.h;
    if (homeE) homeE.textContent = state.stats.home.e;
}

/**
 * ç®¡ç†ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
 */
function updateControlPanel() {
    // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (!isAdminMode) return;
    
    // ãƒãƒ¼ãƒ åå…¥åŠ›
    const awayNameInput = document.getElementById('away-name');
    const homeNameInput = document.getElementById('home-name');
    if (awayNameInput) awayNameInput.value = state.teams.away;
    if (homeNameInput) homeNameInput.value = state.teams.home;
    
    // ãƒ©ãƒ³ãƒŠãƒ¼ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
    const btnRunner1 = document.getElementById('btn-runner-1');
    const btnRunner2 = document.getElementById('btn-runner-2');
    const btnRunner3 = document.getElementById('btn-runner-3');
    if (btnRunner1) btnRunner1.classList.toggle('active', state.runners.first);
    if (btnRunner2) btnRunner2.classList.toggle('active', state.runners.second);
    if (btnRunner3) btnRunner3.classList.toggle('active', state.runners.third);
    
    // ç¾åœ¨ã®æ”»æ’ƒãƒãƒ¼ãƒ è¡¨ç¤º
    const attackingTeam = state.inning.half === 'top' ? state.teams.away : state.teams.home;
    const scoringTeamLabel = document.getElementById('scoring-team-label');
    if (scoringTeamLabel) scoringTeamLabel.textContent = `${attackingTeam}ï¼ˆæ”»æ’ƒä¸­ï¼‰`;
    
    // ç¾åœ¨ã‚¤ãƒ‹ãƒ³ã‚°ã®å¾—ç‚¹
    const inningIndex = state.inning.number - 1;
    const currentScore = state.inning.half === 'top' 
        ? state.scores.away[inningIndex] 
        : state.scores.home[inningIndex];
    const currentInningScore = document.getElementById('current-inning-score');
    if (currentInningScore) currentInningScore.textContent = currentScore;
}

/**
 * æ‰“é †å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆ
 */
function generateLineupInputs() {
    ['away', 'home'].forEach(team => {
        const container = document.getElementById(`lineup-input-${team}`);
        // ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆè¡¨ç¤ºç”»é¢ãªã©ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!container) return;
        container.innerHTML = '';
        
        for (let i = 0; i < 9; i++) {
            const row = document.createElement('div');
            row.className = 'lineup-input-row';
            row.innerHTML = `
                <span class="lineup-input-order">${i + 1}</span>
                <input type="text" 
                       class="lineup-input-name" 
                       data-team="${team}" 
                       data-order="${i}"
                       placeholder="${i + 1}ç•ªæ‰“è€…"
                       maxlength="10"
                       value="${state.lineup[team][i] || ''}">
            `;
            container.appendChild(row);
        }
    });
}

/**
 * æ‰“é †ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°
 */
function updateLineupDisplay() {
    // æ‰“é †ãƒœãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆç®¡ç†ç”»é¢ã®ã¿ã®å ´åˆï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
    const lineupAwayName = document.getElementById('lineup-away-name');
    const lineupHomeName = document.getElementById('lineup-home-name');
    
    // ãƒãƒ¼ãƒ åæ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    if (lineupAwayName) lineupAwayName.textContent = state.teams.away;
    if (lineupHomeName) lineupHomeName.textContent = state.teams.home;
    
    ['away', 'home'].forEach(team => {
        const container = document.getElementById(`${team}-lineup`);
        // ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!container) return;
        
        container.innerHTML = '';
        
        const currentBatterIndex = state.currentBatter[team];
        const isAttacking = (state.inning.half === 'top' && team === 'away') ||
                           (state.inning.half === 'bottom' && team === 'home');
        
        for (let i = 0; i < 9; i++) {
            const playerName = state.lineup[team][i] || ((i + 1) + 'ç•ª');
            const results = state.atBatResults[team][i] || [];
            const isActive = isAttacking && i === currentBatterIndex;
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'lineup-player' + (isActive ? ' active' : '');
            
            // çµæœãƒãƒƒã‚¸ã®HTMLç”Ÿæˆ
            const resultBadges = results.map(result => 
                '<span class="result-badge ' + result + '">' + (RESULT_LABELS[result] || result) + '</span>'
            ).join('');
            
            playerDiv.innerHTML = 
                '<span class="player-order">' + (i + 1) + '</span>' +
                '<span class="player-name">' + playerName + '</span>' +
                '<div class="player-results">' + resultBadges + '</div>';
            container.appendChild(playerDiv);
        }
    });
}

/**
 * ç¾åœ¨ã®æ‰“è€…æƒ…å ±ã‚’æ›´æ–°
 */
function updateCurrentBatterDisplay() {
    const team = state.inning.half === 'top' ? 'away' : 'home';
    const batterIndex = state.currentBatter[team];
    const batterName = state.lineup[team][batterIndex] || '---';
    
    // ç®¡ç†ç”»é¢ç”¨ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼‰
    const batterOrderEl = document.getElementById('current-batter-order');
    const batterNameEl = document.getElementById('current-batter-name');
    if (batterOrderEl) batterOrderEl.textContent = batterIndex + 1;
    if (batterNameEl) batterNameEl.textContent = batterName;
}

// ==================== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ====================
function setupEventListeners() {
    // ãƒãƒ¼ãƒ åå¤‰æ›´
    document.getElementById('away-name').addEventListener('input', (e) => {
        state.teams.away = e.target.value || 'ã‚¢ã‚¦ã‚§ã‚¤';
        updateDisplay();
        saveState();
    });
    
    document.getElementById('home-name').addEventListener('input', (e) => {
        state.teams.home = e.target.value || 'ãƒ›ãƒ¼ãƒ ';
        updateDisplay();
        saveState();
    });
    
    // ãƒœãƒ¼ãƒ«
    document.getElementById('btn-ball').addEventListener('click', () => {
        if (state.count.ball < 3) {
            state.count.ball++;
            if (state.count.ball >= 3) {
                // ãƒ•ã‚©ã‚¢ãƒœãƒ¼ãƒ«ï¼ˆ4ã¤ç›®ã®ãƒœãƒ¼ãƒ«ï¼‰ - ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
                resetCount();
            }
        }
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-ball-reset').addEventListener('click', () => {
        state.count.ball = 0;
        updateDisplay();
        saveState();
    });
    
    // ã‚¹ãƒˆãƒ©ã‚¤ã‚¯
    document.getElementById('btn-strike').addEventListener('click', () => {
        if (state.count.strike < 2) {
            state.count.strike++;
            if (state.count.strike >= 2) {
                // ä¸‰æŒ¯ï¼ˆ3ã¤ç›®ã®ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ï¼‰ - ã‚¢ã‚¦ãƒˆè¿½åŠ  & ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
                addOut();
            }
        }
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-strike-reset').addEventListener('click', () => {
        state.count.strike = 0;
        updateDisplay();
        saveState();
    });
    
    // ã‚¢ã‚¦ãƒˆ
    document.getElementById('btn-out').addEventListener('click', () => {
        addOut();
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-out-reset').addEventListener('click', () => {
        state.count.out = 0;
        updateDisplay();
        saveState();
    });
    
    // ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆï¼ˆæ‰“å¸­äº¤ä»£ï¼‰
    document.getElementById('btn-count-reset').addEventListener('click', () => {
        resetCount();
        updateDisplay();
        saveState();
    });
    
    // ãƒ©ãƒ³ãƒŠãƒ¼
    document.getElementById('btn-runner-1').addEventListener('click', () => {
        state.runners.first = !state.runners.first;
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-runner-2').addEventListener('click', () => {
        state.runners.second = !state.runners.second;
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-runner-3').addEventListener('click', () => {
        state.runners.third = !state.runners.third;
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-runner-clear').addEventListener('click', () => {
        state.runners.first = false;
        state.runners.second = false;
        state.runners.third = false;
        updateDisplay();
        saveState();
    });
    
    // ã‚¤ãƒ‹ãƒ³ã‚°æ“ä½œ
    document.getElementById('btn-inning-prev').addEventListener('click', () => {
        if (state.inning.half === 'bottom') {
            state.inning.half = 'top';
        } else if (state.inning.number > 1) {
            state.inning.number--;
            state.inning.half = 'bottom';
        }
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-inning-next').addEventListener('click', () => {
        advanceInning();
        updateDisplay();
        saveState();
    });
    
    // å¾—ç‚¹æ“ä½œ
    document.getElementById('btn-score-plus').addEventListener('click', () => {
        const inningIndex = state.inning.number - 1;
        const team = state.inning.half === 'top' ? 'away' : 'home';
        state.scores[team][inningIndex]++;
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-score-minus').addEventListener('click', () => {
        const inningIndex = state.inning.number - 1;
        const team = state.inning.half === 'top' ? 'away' : 'home';
        if (state.scores[team][inningIndex] > 0) {
            state.scores[team][inningIndex]--;
        }
        updateDisplay();
        saveState();
    });
    
    // R/H/Eæ“ä½œ
    document.querySelectorAll('[data-team][data-stat]').forEach(btn => {
        btn.addEventListener('click', () => {
            const team = btn.dataset.team;
            const stat = btn.dataset.stat;
            const action = btn.dataset.action;
            
            if (action === 'minus') {
                if (state.stats[team][stat] > 0) {
                    state.stats[team][stat]--;
                }
            } else {
                state.stats[team][stat]++;
            }
            updateDisplay();
            saveState();
        });
    });
    
    // è©¦åˆãƒªã‚»ãƒƒãƒˆ
    document.getElementById('btn-reset-game').addEventListener('click', () => {
        if (confirm('æœ¬å½“ã«è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            state = JSON.parse(JSON.stringify(DEFAULT_STATE));
            generateLineupInputs();
            updateDisplay();
            saveState();
        }
    });
    
    // ==================== æ‰“é †é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ ====================
    
    // æ‰“é †å…¥åŠ›ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('btn-tab-away-lineup').addEventListener('click', () => {
        document.getElementById('btn-tab-away-lineup').classList.add('active');
        document.getElementById('btn-tab-home-lineup').classList.remove('active');
        document.getElementById('lineup-input-away').classList.add('active');
        document.getElementById('lineup-input-home').classList.remove('active');
    });
    
    document.getElementById('btn-tab-home-lineup').addEventListener('click', () => {
        document.getElementById('btn-tab-home-lineup').classList.add('active');
        document.getElementById('btn-tab-away-lineup').classList.remove('active');
        document.getElementById('lineup-input-home').classList.add('active');
        document.getElementById('lineup-input-away').classList.remove('active');
    });
    
    // é¸æ‰‹åå…¥åŠ›
    document.querySelectorAll('.lineup-input-name').forEach(input => {
        input.addEventListener('input', (e) => {
            const team = e.target.dataset.team;
            const order = parseInt(e.target.dataset.order);
            state.lineup[team][order] = e.target.value;
            updateLineupDisplay();
            updateCurrentBatterDisplay();
            saveState();
        });
    });
    
    // å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸæ‰“é †å…¥åŠ›ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    document.getElementById('lineup-input-away').addEventListener('input', handleLineupInput);
    document.getElementById('lineup-input-home').addEventListener('input', handleLineupInput);
    
    // æ‰“å¸­çµæœãƒœã‚¿ãƒ³
    document.querySelectorAll('[data-result]').forEach(btn => {
        btn.addEventListener('click', () => {
            const result = btn.dataset.result;
            recordAtBatResult(result);
        });
    });
    
    // å‰ã®æ‰“è€…/æ¬¡ã®æ‰“è€…
    document.getElementById('btn-prev-batter').addEventListener('click', () => {
        const team = state.inning.half === 'top' ? 'away' : 'home';
        state.currentBatter[team] = (state.currentBatter[team] - 1 + 9) % 9;
        updateDisplay();
        saveState();
    });
    
    document.getElementById('btn-next-batter').addEventListener('click', () => {
        const team = state.inning.half === 'top' ? 'away' : 'home';
        state.currentBatter[team] = (state.currentBatter[team] + 1) % 9;
        updateDisplay();
        saveState();
    });
    
    // çµæœå–ã‚Šæ¶ˆã—
    document.getElementById('btn-undo-result').addEventListener('click', () => {
        undoLastResult();
    });
}

/**
 * æ‰“é †å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©
 */
function handleLineupInput(e) {
    if (e.target.classList.contains('lineup-input-name')) {
        const team = e.target.dataset.team;
        const order = parseInt(e.target.dataset.order);
        state.lineup[team][order] = e.target.value;
        updateLineupDisplay();
        updateCurrentBatterDisplay();
        saveState();
    }
}

/**
 * æ‰“å¸­çµæœã‚’è¨˜éŒ²
 */
function recordAtBatResult(result) {
    const team = state.inning.half === 'top' ? 'away' : 'home';
    const batterIndex = state.currentBatter[team];
    
    // çµæœã‚’è¿½åŠ 
    state.atBatResults[team][batterIndex].push(result);
    
    // å±¥æ­´ã«è¿½åŠ ï¼ˆå–ã‚Šæ¶ˆã—ç”¨ï¼‰
    state.resultHistory.push({
        team: team,
        batterIndex: batterIndex,
        result: result
    });
    
    // ãƒ’ãƒƒãƒˆç³»ã®å ´åˆã€H+1
    if (['single', 'double', 'triple', 'homerun'].includes(result)) {
        state.stats[team].h++;
    }
    
    // ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
    resetCount();
    
    // æ¬¡ã®æ‰“è€…ã¸é€²ã‚ã‚‹
    state.currentBatter[team] = (state.currentBatter[team] + 1) % 9;
    
    updateDisplay();
    saveState();
}

/**
 * ç›´å‰ã®çµæœã‚’å–ã‚Šæ¶ˆã™
 */
function undoLastResult() {
    if (state.resultHistory.length === 0) {
        alert('å–ã‚Šæ¶ˆã™çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    const lastResult = state.resultHistory.pop();
    const { team, batterIndex, result } = lastResult;
    
    // çµæœã‚’å‰Šé™¤
    const results = state.atBatResults[team][batterIndex];
    const idx = results.lastIndexOf(result);
    if (idx !== -1) {
        results.splice(idx, 1);
    }
    
    // ãƒ’ãƒƒãƒˆç³»ã®å ´åˆã€H-1
    if (['single', 'double', 'triple', 'homerun'].includes(result)) {
        if (state.stats[team].h > 0) {
            state.stats[team].h--;
        }
    }
    
    // æ‰“è€…ã‚’æˆ»ã™
    state.currentBatter[team] = batterIndex;
    
    updateDisplay();
    saveState();
}

// ==================== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ====================
/**
 * ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ‰“å¸­äº¤ä»£æ™‚ï¼‰
 */
function resetCount() {
    state.count.ball = 0;
    state.count.strike = 0;
}

/**
 * ã‚¢ã‚¦ãƒˆã‚’è¿½åŠ ï¼ˆ3ã‚¢ã‚¦ãƒˆã§ã‚¤ãƒ‹ãƒ³ã‚°é€²è¡Œï¼‰
 */
function addOut() {
    if (state.count.out < 2) {
        state.count.out++;
        resetCount();
    } else {
        // 3ã‚¢ã‚¦ãƒˆãƒã‚§ãƒ³ã‚¸
        state.count.out = 0;
        resetCount();
        clearRunners();
        advanceInning();
    }
}

/**
 * ãƒ©ãƒ³ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
 */
function clearRunners() {
    state.runners.first = false;
    state.runners.second = false;
    state.runners.third = false;
}

/**
 * ã‚¤ãƒ‹ãƒ³ã‚°ã‚’é€²ã‚ã‚‹
 */
function advanceInning() {
    if (state.inning.half === 'top') {
        state.inning.half = 'bottom';
    } else {
        state.inning.half = 'top';
        if (state.inning.number < 12) {
            state.inning.number++;
        }
    }
}

