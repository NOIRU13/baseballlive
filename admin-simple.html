<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>管理パネル - Baseball Live</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body class="admin-mode">
    <div class="control-panel">
      <!-- Admin Header with Tabs -->
      <div class="admin-header">
        <h1 class="panel-title">⚾ 管理パネル</h1>
        <div class="admin-tabs">
            <button class="tab-btn active" data-tab="simple">簡易操作</button>
            <button class="tab-btn" data-tab="lineup">オーダー管理</button>
            <button class="tab-btn" data-tab="db">DB管理</button>
            <button class="tab-btn" data-tab="control">試合管理</button>
        </div>
      </div>

      <!-- ==================== Tab: Simple (簡易操作) ==================== -->
      <div id="tab-simple" class="tab-content active">
          <!-- 現在の状況表示 -->
          <div class="current-info" style="text-align:center; margin-bottom:10px; background:rgba(255,215,0,0.1); padding:5px; border-radius:4px;">
            <div class="current-info-label" style="font-size:10px; color:#ffd700;">現在の打者</div>
            <div class="current-info-value" id="current-batter-name" style="font-weight:bold;">---</div>
          </div>
          
          <div class="simple-grid">
            <!-- カウント操作 -->
            <section class="simple-section">
              <h3>カウント</h3>
              <div class="count-controls">
                <div class="control-group">
                  <span class="control-label">ボール</span>
                  <div class="btn-group">
                    <button id="btn-ball" class="btn btn-ball">B +</button>
                    <button id="btn-ball-reset" class="btn btn-reset">Reset</button>
                  </div>
                </div>
                <div class="control-group">
                  <span class="control-label">ストライク</span>
                  <div class="btn-group">
                    <button id="btn-strike" class="btn btn-strike">S +</button>
                    <button id="btn-strike-reset" class="btn btn-reset">Reset</button>
                  </div>
                </div>
                <div class="control-group">
                  <span class="control-label">アウト</span>
                  <div class="btn-group">
                    <button id="btn-out" class="btn btn-out">O +</button>
                    <button id="btn-out-reset" class="btn btn-reset">Reset</button>
                  </div>
                </div>
              </div>
              <button id="btn-count-reset" class="btn btn-full btn-warning" style="margin-top:10px; width:100%;">
                カウントリセット
              </button>
            </section>
            
            <!-- ランナー操作 -->
            <section class="simple-section">
              <h3>ランナー</h3>
              <div class="runner-controls-simple">
                <div class="diamond-simple">
                  <button id="btn-runner-2" class="base-btn second" title="2塁"></button>
                  <button id="btn-runner-3" class="base-btn third" title="3塁"></button>
                  <button id="btn-runner-1" class="base-btn first" title="1塁"></button>
                </div>
              </div>
              <button id="btn-runner-clear" class="btn btn-full btn-warning" style="width:100%;">
                ランナークリア
              </button>
            </section>
            
            <!-- 打席結果入力（安打・出塁） -->
            <section class="simple-section">
              <h3>打席結果 (出塁)</h3>
              <div class="result-buttons">
                <!-- Row 1: Home Run -->
                <div class="result-row">
                  <span class="result-category">本塁打</span>
                  <button data-result="homerun" class="btn btn-result btn-homerun">本塁打</button>
                </div>
                <!-- Row 2: Hits -->
                <div class="result-row">
                  <span class="result-category">安打</span>
                  <button data-result="single" class="btn btn-result btn-hit">単打</button>
                  <button data-result="double" class="btn btn-result btn-hit">二塁打</button>
                  <button data-result="triple" class="btn btn-result btn-hit">三塁打</button>
                </div>
                <!-- Row 3: Timely -->
                <div class="result-row">
                  <span class="result-category">ﾀｲﾑﾘｰ</span>
                  <button id="btn-timely-1" class="btn btn-result btn-timely">1</button>
                  <button id="btn-timely-2" class="btn btn-result btn-timely">2</button>
                  <button id="btn-timely-3" class="btn btn-result btn-timely">3</button>
                </div>
                <!-- Row 4: Walk, Error, etc -->
                <div class="result-row">
                  <span class="result-category">四死球他</span>
                  <button data-result="walk" class="btn btn-result btn-walk">四球</button>
                  <button data-result="hbp" class="btn btn-result btn-walk">死球</button>
                  <button data-result="error" class="btn btn-result btn-other">エラー</button>
                </div>
              </div>
            </section>
            
             <!-- 打席結果入力（アウト・他） -->
             <section class="simple-section">
                <h3>打席結果 (凡退)</h3>
                <div class="result-buttons">
                  <div class="result-row">
                    <span class="result-category">凡退</span>
                    <button data-result="strikeout" class="btn btn-result btn-out-result">三振</button>
                    <button data-result="groundout" class="btn btn-result btn-out-result">ゴロ</button>
                    <button data-result="flyout" class="btn btn-result btn-out-result">フライ</button>
                    <button data-result="lineout" class="btn btn-result btn-out-result">ライナー</button>
                  </div>
                  <div class="result-row">
                    <span class="result-category">他</span>
                    <button data-result="sacrifice" class="btn btn-result btn-other">犠打</button>
                    <button data-result="fc" class="btn btn-result btn-other">FC</button>
                    <button data-result="dp" class="btn btn-result btn-out-result">併殺</button>
                  </div>
                </div>
                <button id="btn-undo-result" class="btn btn-full btn-warning" style="width:100%;">
                  直前の結果を取り消す
                </button>
              </section>
          </div>
      </div>

      <!-- ==================== Tab: Lineup (オーダー管理) ==================== -->
      <div id="tab-lineup" class="tab-content">
          <section class="team-select-section">
            <h2>チーム選択</h2>
            <div class="team-inputs">
              <div class="input-group">
                <label for="away-team-select">先攻チーム</label>
                <select id="away-team-select" class="team-select" style="width:100%; padding:5px;">
                  <option value="">チームを選択...</option>
                </select>
              </div>
              <div class="input-group">
                <label for="home-team-select">後攻チーム</label>
                <select id="home-team-select" class="team-select" style="width:100%; padding:5px;">
                  <option value="">チームを選択...</option>
                </select>
              </div>
            </div>
            
             <div style="text-align: center; margin-top:10px;">
                <button id="btn-save-lineup" class="btn btn-success">保存</button>
                <span id="save-status" style="margin-left: 12px; font-size: 14px; color: #2ecc71; opacity: 0; transition: opacity 0.3s;"></span>
              </div>
              
              <!-- スタメンテンプレート機能 -->
              <div class="template-section" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #ffd700;">📋 スタメンテンプレート</h3>
                <div class="template-controls" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                  <div class="template-team" style="flex: 1; min-width: 200px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <span style="font-size: 12px; color: #aaa;">先攻チーム</span>
                    <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                      <button id="btn-save-template-away" class="btn btn-template" style="font-size: 11px; padding: 4px 8px; background: #3498db;">テンプレ保存</button>
                      <button id="btn-load-template-away" class="btn btn-template" style="font-size: 11px; padding: 4px 8px; background: #27ae60;">テンプレ読込</button>
                    </div>
                  </div>
                  <div class="template-team" style="flex: 1; min-width: 200px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <span style="font-size: 12px; color: #aaa;">後攻チーム</span>
                    <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                      <button id="btn-save-template-home" class="btn btn-template" style="font-size: 11px; padding: 4px 8px; background: #3498db;">テンプレ保存</button>
                      <button id="btn-load-template-home" class="btn btn-template" style="font-size: 11px; padding: 4px 8px; background: #27ae60;">テンプレ読込</button>
                    </div>
                  </div>
                </div>
              </div>
          </section>

          <style>
             .btn-sub-player {
                 padding: 2px 6px; font-size: 10px; background: #e74c3c; color: #fff; border: none; border-radius: 3px; cursor: pointer; margin-left: 5px;
             }
             .btn-sub-player:hover { background: #c0392b; }
          </style>

          <div class="lineups-row">
            <!-- 先攻チーム（左側） -->
            <section class="lineup-column section">
              <h3 class="lineup-team-title">先攻（ビジター）</h3>
              <div id="lineup-input-away" class="lineup-input-panel">
                 <!-- JS will generate content -->
              </div>
            </section>
            
            <!-- 後攻チーム（右側） -->
            <section class="lineup-column section">
              <h3 class="lineup-team-title">後攻（ホーム）</h3>
              <div id="lineup-input-home" class="lineup-input-panel">
                <!-- JS will generate content -->
              </div>
            </section>
          </div>
      </div>

      <!-- ==================== Tab: DB (DB管理) ==================== -->
      <div id="tab-db" class="tab-content">
           <div class="db-tabs">
            <button class="db-tab-btn active" onclick="showDbTab('teams')">チーム管理</button>
            <button class="db-tab-btn" onclick="showDbTab('players')">選手管理</button>
            <button class="db-tab-btn" onclick="showDbTab('stats')">成績管理</button>
          </div>

          <!-- チーム管理タブ -->
          <div id="teams-tab" class="db-tab-content active">
            <div class="section">
              <h2>チーム登録</h2>
              <form id="team-form">
                <input type="hidden" id="team-id">
                <div class="flex-row">
                    <div class="form-group flex-1">
                      <label for="team-name">チーム名</label>
                      <input type="text" id="team-name" required placeholder="例: Hanshin Tigers">
                    </div>
                    <div class="form-group flex-1">
                      <label for="team-short-name">略称</label>
                      <input type="text" id="team-short-name" required placeholder="例: 阪神">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
                <button type="button" onclick="resetTeamForm()" class="btn" style="background:transparent; border:1px solid #aaa;">キャンセル</button>
              </form>
            </div>

            <div class="section">
              <h2>登録済みチーム一覧</h2>
              <table id="teams-table">
                <thead><tr><th>ID</th><th>チーム名</th><th>略称</th><th>操作</th></tr></thead>
                <tbody><!-- JSで挿入 --></tbody>
              </table>
            </div>
          </div>

          <!-- 選手管理タブ -->
          <div id="players-tab" class="db-tab-content">
            <div class="section">
              <h2>選手登録</h2>
              <form id="player-form">
                <input type="hidden" id="player-id">
                <div class="form-group">
                    <label for="player-team-select">所属チーム</label>
                    <select id="player-team-select" required></select>
                </div>
                <div class="flex-row">
                    <div class="form-group flex-1">
                      <label for="player-name">選手名</label>
                      <input type="text" id="player-name" required placeholder="例: 佐藤 輝明">
                    </div>
                    <div class="form-group" style="width: 80px;">
                      <label for="player-number">背番号</label>
                      <input type="number" id="player-number" placeholder="8">
                    </div>
                </div>
                <div class="flex-row">
                     <div class="form-group flex-1">
                      <label for="player-position">ポジション</label>
                      <select id="player-position">
                          <option value="P">P (投手)</option>
                          <option value="C">C (捕手)</option>
                          <option value="IF">IF (内野手)</option>
                          <option value="OF">OF (外野手)</option>
                      </select>
                    </div>
                    <div class="form-group flex-1">
                      <label for="player-hand">投打</label>
                      <input type="text" id="player-hand" placeholder="例: 右投左打">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
                <button type="button" onclick="resetPlayerForm()" class="btn" style="background:transparent; border:1px solid #aaa;">キャンセル</button>
              </form>
            </div>

            <div class="section">
              <h2>選手一覧</h2>
              <div class="form-group">
                  <label>チームでフィルタ</label>
                  <select id="filter-team-select" onchange="loadPlayers()">
                      <option value="">全チーム</option>
                  </select>
              </div>
              <div style="overflow-x:auto;">
                <table id="players-table">
                    <thead><tr><th>#</th><th>選手名</th><th>守</th><th>投打</th><th>チーム</th><th>操作</th></tr></thead>
                    <tbody><!-- JSで挿入 --></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 成績管理タブ -->
          <div id="stats-tab" class="db-tab-content">
             <div class="section">
                 <h2>CSVインポート</h2>
                 <div class="form-group">
                     <label>データの種類</label>
                     <select id="import-type">
                         <option value="batting">打撃成績</option>
                         <option value="pitching">投手成績</option>
                         <option value="players">選手情報</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <input type="file" id="csv-file" accept=".csv">
                 </div>
                 <button onclick="uploadCsv()" class="btn btn-primary">インポート</button>
                 <div id="upload-status" style="margin-top: 5px; font-size:12px;"></div>
             </div>
             
             <div class="section">
                 <h2>CSV エクスポート</h2>
                 <div class="flex-row">
                     <button onclick="exportCsv('batting')" class="btn btn-primary" style="font-size:10px;">打撃成績DL</button>
                     <button onclick="exportCsv('pitching')" class="btn btn-primary" style="font-size:10px;">投手成績DL</button>
                 </div>
             </div>

             <div class="section">
                  <h2>チーム別成績リセット</h2>
                  <div class="form-group flex-row" style="align-items: center;">
                    <select id="stats-team-filter" style="width: auto; min-width: 150px; margin-right: 5px;">
                        <option value="">（チーム選択）</option>
                    </select>
                    <button id="btn-reset-team-stats" class="btn btn-danger" onclick="resetTeamStats()" disabled>一括削除</button>
                  </div>
             </div>

            <div class="section">
                <h2>成績詳細</h2>
                <div class="db-tabs" style="margin-bottom: 5px;">
                    <button class="db-tab-btn active" id="btn-stats-batting" onclick="switchStatsTab('batting')">打撃</button>
                    <button class="db-tab-btn" id="btn-stats-pitching" onclick="switchStatsTab('pitching')">投手</button>
                </div>
                
                 <!-- Manual Stats Form (Collapsible or just visible) -->
                 <div style="margin-bottom:15px; border:1px dashed #555; padding:5px;">
                     <h4 style="margin:0 0 5px 0; color:#aaa; font-size:12px;">手動編集・登録</h4>
                      <form id="stats-form">
                        <input type="hidden" id="stats-id">
                        <input type="hidden" id="stats-type" value="batting">
                        <div class="flex-row">
                            <div class="form-group flex-1">
                                <label>チーム</label>
                                <select id="stats-form-team-select" onchange="loadPlayersForStats(this.value)" required></select>
                            </div>
                            <div class="form-group flex-1">
                                <label>選手</label>
                                <select id="stats-player-select" required></select>
                            </div>
                             <div class="form-group" style="width:60px;">
                                <label>年度</label>
                                <input type="number" id="stats-season" value="2026" required>
                            </div>
                        </div>
                        
                        <!-- Batting Fields -->
                        <div id="batting-fields">
                            <div class="flex-row">
                                <input type="text" id="stats-batting-average" placeholder="打率" class="flex-1">
                                <input type="number" id="stats-games-b" placeholder="試合" class="flex-1">
                                <input type="number" id="stats-at-bats" placeholder="打数" class="flex-1">
                                <input type="number" id="stats-hits" placeholder="安打" class="flex-1">
                            </div>
                            <div class="flex-row" style="margin-top:5px;">
                                <input type="number" id="stats-home-runs" placeholder="HR" class="flex-1">
                                <input type="number" id="stats-rbis" placeholder="打点" class="flex-1">
                                <input type="text" id="stats-ops" placeholder="OPS" class="flex-1">
                            </div>
                        </div>
                        <!-- Pitching Fields -->
                        <div id="pitching-fields" style="display:none;">
                             <div class="flex-row">
                                <input type="text" id="stats-era" placeholder="防御率" class="flex-1">
                                <input type="number" id="stats-games-p" placeholder="登板" class="flex-1">
                                <input type="number" id="stats-wins" placeholder="勝" class="flex-1">
                                <input type="number" id="stats-losses" placeholder="負" class="flex-1">
                            </div>
                            <div class="flex-row" style="margin-top:5px;">
                                <input type="number" id="stats-saves" placeholder="S" class="flex-1">
                                <input type="text" id="stats-innings" placeholder="回" class="flex-1">
                                <input type="number" id="stats-strikeouts" placeholder="三振" class="flex-1">
                            </div>
                        </div>
                        <div style="margin-top:5px; text-align:right;">
                             <button type="submit" class="btn btn-primary" style="padding:4px 8px;">保存</button>
                             <button type="button" onclick="resetStatsForm()" class="btn" style="padding:4px 8px; background:#555;">Clear</button>
                        </div>
                      </form>
                 </div>

                <div style="overflow-x: auto; max-height:300px;">
                    <table id="stats-table">
                        <thead><!-- JS --></thead>
                        <tbody><!-- JS --></tbody>
                    </table>
                </div>
            </div>
          </div>
      </div>

      <!-- ==================== Tab: Control (試合管理) ==================== -->
      <div id="tab-control" class="tab-content">
           <div class="control-layout">
            <div class="control-column">
              <!-- イニング操作 -->
              <section class="control-section">
                <h2>イニング</h2>
                <div class="inning-controls">
                  <button id="btn-inning-prev" class="btn btn-reset">◀</button>
                  <span class="inning-info" id="inning-info" style="font-weight:bold; font-size:16px; color:#ffd700;">1回 表</span>
                  <button id="btn-inning-next" class="btn btn-reset">▶</button>
                </div>
              </section>
              
              <!-- 得点操作 -->
              <section class="control-section">
                <h2>得点</h2>
                <div class="score-controls">
                  <span class="team-label" id="scoring-team-label" style="color:#aaa;">攻撃チーム</span>
                  <div class="btn-group">
                    <button id="btn-score-minus" class="btn btn-reset">−</button>
                    <span id="current-inning-score" class="current-score">0</span>
                    <button id="btn-score-plus" class="btn btn-reset">＋</button>
                  </div>
                </div>
              </section>
              
              <!-- R/H/E操作 -->
              <section class="control-section">
                <h2>Hits / Errors</h2>
                <div class="rhe-controls">
                  <div class="rhe-team-controls">
                    <span class="team-label">先攻</span>
                    <div class="btn-group">
                      <button data-team="away" data-stat="h" class="btn btn-reset">H+</button>
                      <button data-team="away" data-stat="h" data-action="minus" class="btn btn-reset">H−</button>
                      <button data-team="away" data-stat="e" class="btn btn-reset">E+</button>
                      <button data-team="away" data-stat="e" data-action="minus" class="btn btn-reset">E−</button>
                    </div>
                  </div>
                  <div class="rhe-team-controls">
                    <span class="team-label">後攻</span>
                    <div class="btn-group">
                      <button data-team="home" data-stat="h" class="btn btn-reset">H+</button>
                      <button data-team="home" data-stat="h" data-action="minus" class="btn btn-reset">H−</button>
                      <button data-team="home" data-stat="e" class="btn btn-reset">E+</button>
                      <button data-team="home" data-stat="e" data-action="minus" class="btn btn-reset">E−</button>
                    </div>
                  </div>
                </div>
              </section>

              <!-- 投手成績 (新設) -->
              <section class="control-section">
                <h2>投手成績 (当日)</h2>
                <div class="pitcher-stats-summary" style="font-size: 11px;">
                  <div style="margin-bottom: 8px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                    <div style="color: #ffd700; margin-bottom: 2px;">先攻投手</div>
                    <div style="display: flex; gap: 10px;">
                      <span>回: <input type="number" id="pitcher-innings-away" step="0.1" style="width: 35px; background: #222; color: #fff; border: 1px solid #444;"></span>
                      <span>振: <input type="number" id="pitcher-k-away" style="width: 30px; background: #222; color: #fff; border: 1px solid #444;"></span>
                      <span>失: <input type="number" id="pitcher-runs-away" style="width: 30px; background: #222; color: #fff; border: 1px solid #444;" readonly></span>
                    </div>
                  </div>
                  <div style="padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                    <div style="color: #ffd700; margin-bottom: 2px;">後攻投手</div>
                    <div style="display: flex; gap: 10px;">
                      <span>回: <input type="number" id="pitcher-innings-home" step="0.1" style="width: 35px; background: #222; color: #fff; border: 1px solid #444;"></span>
                      <span>振: <input type="number" id="pitcher-k-home" style="width: 30px; background: #222; color: #fff; border: 1px solid #444;"></span>
                      <span>失: <input type="number" id="pitcher-runs-home" style="width: 30px; background: #222; color: #fff; border: 1px solid #444;" readonly></span>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 9px; color: #888;">※失点は打席ログから自動計算されます</div>
                </div>
              </section>
              
              <!-- 打者操作 -->
              <section class="control-section">
                <h2>打者操作</h2>
                <div class="at-bat-info">
                  <div class="current-batter-info">
                    <span class="batter-order" id="current-batter-order">1</span>
                    <span class="batter-name" id="current-batter-name-control">---</span>
                  </div>
                  <div class="at-bat-label">現在の打者</div>
                </div>
                <div class="batter-nav">
                  <button id="btn-prev-batter" class="btn btn-batter-nav">◀ 前</button>
                  <button id="btn-next-batter" class="btn btn-batter-nav">次 ▶</button>
                </div>
              </section>
              
              <!-- リセット -->
              <section class="control-section">
                <button id="btn-reset-game" class="btn btn-full btn-danger">
                  🔄 全リセット
                </button>
              </section>
            </div>

            <!-- 打席履歴詳細 (新設) -->
            <div class="control-column log-column" style="flex: 2; min-width: 400px;">
               <section class="control-section">
                 <h2>打席ログ・詳細編集</h2>
                 <div id="at-bat-log-container" class="log-table-wrapper" style="overflow-y: auto; max-height: 500px; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 5px;">
                   <table class="at-bat-log-table" style="width: 100%; border-collapse: collapse; font-size: 11px;">
                     <thead>
                       <tr style="border-bottom: 1px solid #444; color: #ffd700;">
                         <th style="padding: 4px; text-align: left;">イニング</th>
                         <th style="padding: 4px; text-align: left;">打者</th>
                         <th style="padding: 4px; text-align: left;">投手</th>
                         <th style="padding: 4px; text-align: left;">結果</th>
                         <th style="padding: 4px; text-align: center;">打点</th>
                         <th style="padding: 4px; text-align: center;">失点</th>
                         <th style="padding: 4px; text-align: center;">自責</th>
                         <th style="padding: 4px; text-align: center;">操作</th>
                       </tr>
                     </thead>
                     <tbody id="at-bat-log-body">
                       <!-- JSで生成 -->
                     </tbody>
                   </table>
                 </div>
               </section>
            </div>
          </div>
      </div>

    </div>
    
    <script type="module" src="js/app.js"></script>
    <script src="js/admin-db.js"></script>
    <script src="js/admin-tabs.js"></script>
  </body>
</html>
