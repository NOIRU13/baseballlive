# 直前の結果を取り消す際のログ削除修正

## 完了報告

以下の修正を実施し、完了しました。

## 修正内容

### 1. `js/logic/game.js` の修正

- `recordAtBatResult` 関数に、第3引数 `hasLog` (boolean) を追加しました。これにより、そのプレイが得点ログを生成すべきものであったか（RBI > 0 か）を履歴に保存します。
- `undoLastResult` 関数を修正し、得点ログを削除する条件を以下のように変更しました。
  ```javascript
  if (
    hasLog &&
    currentTotalScore > restoredTotalScore &&
    state.scoreLogs &&
    state.scoreLogs.length > 0
  ) {
    state.scoreLogs.shift();
  }
  ```
  これにより、「得点ログを生成したプレイ」かつ「実際に得点が減った（元に戻った）」場合のみ、ログを削除するようになります。

### 2. `js/app.js` の修正

- 打席結果ボタンのクリックイベントハンドラをリファクタリングしました。
- **タイムリーエラー処理の改善**:
  - 従来: `得点加算` → `recordAtBatResult` の順だったため、履歴に「得点加算後」の状態が保存され、Undo時に得点が戻らない問題がありました。
  - 修正: `timelyErrorRuns` を計算後、**得点加算を行う前に** `recordAtBatResult` を呼び出すように変更しました。これにより、履歴に「得点加算前」の状態が保存され、Undo時に正しく得点が減るようになります。
- `recordAtBatResult` 呼び出し時に、計算した `rbi > 0` を `hasLog` 引数として渡すようにしました。

## 効果

- Undo時に、関係のない（非スコアリングプレイの）ログが削除されるリスクがなくなりました。
- タイムリーエラーをUndoした際に、正しく得点が減り、かつ得点ログも削除されるようになりました。
- 「得点が減らなかった場合（＝Undoによってスコアが変わらなかった場合）にはログを消さない」というユーザーの要望を、ロジックとして確実に保証しました。
