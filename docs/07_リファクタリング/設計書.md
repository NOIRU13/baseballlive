# リファクタリング設計書

## モジュール構成案

`js/` ディレクトリを作成し、以下のファイルを配置する。

### 1. `js/data/state.js`

- **役割**: アプリケーションの状態管理、初期値定義。
- **Export**: `initialState`, `state` (Proxy推奨だが、単純なオブジェクトでも可), `loadState`, `saveState`, `deepMerge`。
- **依存**: `api.js` (保存処理), `sync.js` (同期処理)

### 2. `js/data/constants.js`

- **役割**: 定数定義。
- **Export**: `DEFAULT_STATE` (state.jsへ移動可), `RESULT_LABELS`, `POSITIONS`, `STORAGE_KEY`, `CHANNEL_NAME`, `API_BASE_URL`。

### 3. `js/logic/game.js`

- **役割**: 野球のルールロジック。純粋な関数として定義し、Stateを受け取って変更するか、変更内容を返す。
- **Export**: `advanceInning`, `addOut`, `resetCount`, `clearRunners`, `recordAtBatResult`, `undoLastResult`, `updatePitcherStats`。

### 4. `js/ui/render.js`

- **役割**: DOMの更新。
- **Export**: `updateDisplay`, `updateScoreDisplay`, `updateLineupDisplay` 等の個別の描画関数。

### 5. `js/ui/dom.js` (Optional)

- **役割**: DOM要素の取得、ヘルパー関数。
- **Export**: `getElement`, `addListener`。

### 6. `js/infra/api.js`

- **役割**: サーバーとの通信。
- **Export**: `checkAPIHealth`, `fetchState`, `postState`。

### 7. `js/infra/sync.js`

- **役割**: タブ間同期 (BroadcastChannel)。
- **Export**: `setupBroadcastChannel`, `broadcastState`, `broadcastResult`。

### 8. `js/app.js` (Entry Point)

- **役割**: 初期化、イベントリスナー登録。既存の `DOMContentLoaded` 内の処理。
- **Import**: 上記全てのモジュール。

## ディレクトリ構造

```
BaseballLive/
  ├── js/
  │   ├── app.js           (メインスクリプト)
  │   ├── data/
  │   │   ├── state.js
  │   │   └── constants.js
  │   ├── logic/
  │   │   └── game.js
  │   ├── ui/
  │   │   ├── render.js
  │   │   └── dom.js
  │   └── infra/
  │       ├── api.js
  │       └── sync.js
  ├── script.js (削除またはバックアップ)
  └── ...
```

## 移行手順

1. `js` ディレクトリとサブディレクトリを作成。
2. `script.js` から定数、State管理、ロジック、UI、イベントリスナーを切り出して各ファイルに配置。
3. `index.html`, `admin.html` などの `<script src="script.js"></script>` を `<script type="module" src="./js/app.js"></script>` に変更。
4. 動作確認。
